val sincostable = (arrszref)$arrpsz{int}(
  100000, 165536,
  101613, 165516,
  103226, 165456,
  104836, 165357,
  106444, 165218,
  108047, 165039,
  109646, 164822,
  111239, 164564,
  112826, 164268,
  114404, 163933,
  115974, 163559,
  117534, 163146,
  119083, 162696,
  120621, 162207,
  122146, 161680,
  123658, 161116,
  125155, 160515,
  126638, 159877,
  128104, 159203,
  129553, 158494,
  130984, 157748,
  132397, 156968,
  133789, 156153,
  135162, 155304,
  136512, 154422,
  137841, 153506,
  139147, 152558,
  140429, 151579,
  141687, 150568,
  142919, 149526,
  144126, 148454,
  145305, 147353,
  146457, 146223,
  147581, 145065,
  148676, 143880,
  149742, 142669,
  150777, 141431,
  151782, 140168,
  152755, 138881,
  153697, 137571,
  154605, 136237,
  155481, 134882,
  156323, 133505,
  157131, 132108,
  157904, 130692,
  158642, 129257,
  159345, 127805,
  160011, 126335,
  160641, 124850,
  161235, 123349,
  161791, 121834,
  162310, 120306,
  162791, 118766,
  163234, 117214,
  163639, 115652,
  164005, 114081,
  164332, 112501,
  164620, 110913,
  164870, 109319,
  165079, 107719,
  165250, 106114,
  165380, 104506,
  165472, 102895,
  165523, 101282,
  165535, 99670,
  165507, 98056,
  165439, 96444,
  165332, 94834,
  165185, 93227,
  164998, 91624,
  164772, 90026,
  164507, 88435,
  164203, 86850,
  163859, 85273,
  163477, 83706,
  163057, 82148,
  162598, 80601,
  162102, 79065,
  161567, 77543,
  160996, 76034,
  160387, 74539,
  159742, 73060,
  159061, 71598,
  158344, 70152,
  157591, 68725,
  156804, 67316,
  155982, 65928,
  155126, 64560,
  154237, 63213,
  153314, 61889,
  152360, 60588,
  151374, 59311,
  150356, 58058,
  149308, 56831,
  148231, 55630,
  147124, 54456,
  145988, 53310,
  144825, 52192,
  143634, 51103,
  142417, 50043,
  141174, 49014,
  139906, 48016,
  138614, 47049,
  137299, 46114,
  135961, 45212,
  134601, 44344,
  133220, 43509,
  131819, 42708,
  130399, 41942,
  128961, 41211,
  127504, 40516,
  126032, 39857,
  124543, 39234,
  123039, 38648,
  121522, 38099,
  119991, 37588,
  118449, 37115,
  116895, 36680,
  115331, 36283,
  113757, 35925,
  112176, 35606,
  110587, 35325,
  108991, 35084,
  107390, 34883,
  105785, 34720,
  104176, 34598,
  102564, 34515,
  100951, 34471,
  99339, 34468,
  97725, 34504,
  96114, 34580,
  94504, 34695,
  92898, 34851,
  91296, 35045,
  89699, 35279,
  88109, 35552,
  86526, 35865,
  84951, 36216,
  83385, 36606,
  81830, 37034,
  80285, 37500,
  78752, 38005,
  77232, 38547,
  75726, 39126,
  74235, 39742,
  72759, 40395,
  71300, 41083,
  69858, 41808,
  68434, 42568,
  67030, 43362,
  65645, 44191,
  64282, 45054,
  62940, 45950,
  61620, 46879,
  60324, 47840,
  59052, 48832,
  57804, 49856,
  56583, 50910,
  55387, 51994,
  54219, 53107,
  53078, 54248,
  51966, 55417,
  50883, 56614,
  49830, 57836,
  48807, 59084,
  47815, 60357,
  46855, 61654,
  45927, 62974,
  45031, 64316,
  44170, 65680,
  43342, 67065,
  42548, 68470,
  41789, 69894,
  41065, 71337,
  40378, 72796,
  39726, 74272,
  39111, 75764,
  38532, 77271,
  37991, 78791,
  37488, 80324,
  37023, 81869,
  36595, 83425,
  36206, 84991,
  35856, 86566,
  35545, 88150,
  35273, 89740,
  35040, 91337,
  34846, 92939,
  34692, 94545,
  34577, 96155,
  34503, 97766,
  34467, 99380,
  34472, 100992,
  34516, 102605,
  34600, 104217,
  34724, 105826,
  34887, 107431,
  35090, 109032,
  35332, 110627,
  35613, 112216,
  35934, 113798,
  36293, 115371,
  36690, 116935,
  37127, 118488,
  37601, 120031,
  38113, 121561,
  38662, 123078,
  39249, 124581,
  39873, 126069,
  40533, 127542,
  41229, 128998,
  41961, 130436,
  42728, 131855,
  43529, 133256,
  44365, 134636,
  45235, 135995,
  46138, 137333,
  47073, 138648,
  48041, 139939,
  49040, 141206,
  50070, 142448,
  51130, 143665,
  52220, 144855,
  53339, 146017,
  54486, 147152,
  55661, 148259,
  56862, 149336,
  58090, 150383,
  59343, 151399,
  60621, 152385,
  61922, 153338,
  63247, 154260,
  64594, 155148,
  65963, 156003,
  67352, 156824,
  68761, 157611,
  70189, 158362,
  71635, 159079,
  73098, 159759,
  74577, 160403,
  76072, 161011,
  77581, 161582,
  79104, 162115,
  80640, 162610,
  82187, 163068,
  83745, 163488,
  85313, 163869,
  86890, 164211,
  88475, 164514,
  90067, 164778,
  91665, 165003,
  93268, 165189,
  94875, 165335,
  96485, 165441,
  98097, 165508,
  99711, 165535
)
  
fn get_sin_cos (angle: int): (int, int) = let
  val truncated_selection = angle % 256
in
  if truncated_selection > 255 then
    (0,0)
  else
    let
      val s = sincostable[2 * truncated_selection] - 100000
      val c = sincostable[2 * truncated_selection + 1] - 100000
    in
      (s, c)
    end
end

fn get_second_and_third_choices (first : int) : (int, int) = let
  val second_choice : int = if first = 0 then 1 else 0
  val third_choice : int =
    case+ (first, second_choice) of
    | (0,1) => 2
    | (1,0) => 2
    | (0,2) => 1
    | (_,_) => 1
in
  (second_choice, third_choice)
end

fn prim_triangle_decomp (ax : int, ay : int, bx : int, by : int, cx : int, cy : int) : struct_triangle_decomp = let
  var decomp : struct_triangle_decomp
in
  decomp.ax := ax;
  decomp.ay := ay;
  decomp.bx := bx;
  decomp.by := by;
  decomp.cx := cx;
  decomp.cy := cy;
  decomp.a_eq_b := (if ay = by then 1 else 0);
  decomp.b_eq_c := (if by = cy then 1 else 0);
  decomp
end

fn second_third_choice (q2y : int, q3y : int, second_choice : int, third_choice : int): (int, int) = let
  val second : int =
    if q2y <= q3y then
      second_choice
    else
      third_choice
  val third =
    if eq_g0int_int (second, second_choice) then
      third_choice
    else
      second_choice
in
  (second, third)
end

fn fixup_decomp (d : !struct_triangle_decomp) : struct_triangle_decomp = let
  val first =
    if d.ay <= d.by && d.ay <= d.cy then 0
    else if d.by <= d.ay && d.by <= d.cy then 1
    else 2
  val (second_choice, third_choice) = get_second_and_third_choices first
  val (p1x, p1y) = choose_point (d, first)
  val (q2x, q2y) = choose_point (d, second_choice)
  val (q3x, q3y) = choose_point (d, third_choice)
  val (second, third) = second_third_choice (q2y, q3y, second_choice, third_choice)
  val third = (if second = second_choice then third_choice else second_choice)
  val (p2x, p2y) = choose_point (d, second)
  val (p3x, p3y) = choose_point (d, third)
in
  prim_triangle_decomp (p1x, p1y, p2x, p2y, p3x, p3y)
end

fn decompose_triangle (ax : int, ay : int, bx : int, by : int, cx : int, cy : int) : struct_triangle_decomp = let
  val primt = prim_triangle_decomp (ax, ay, bx, by, cx, cy)
in
  fixup_decomp primt
end

fn get_xa_xb (xa : int, xb : int) : (int, int) =
  if xa < xb then
    (xa, xb)
  else
    (xb, xa)

fn insert_raster (color : int, depth : int, y : int, xa : int, xb : int) = let
  val (x1, x2) = get_xa_xb (xa, xb)
  val old_list = get_line_ptr (y, NIL)
  val new_list = insert_into (old_list, d_list_ent (color, x1, x2, depth))
  val empty_list = get_line_ptr (y, new_list)
in
  consume_list empty_list ;
  consume_list old_list
end

fn make_triangle (color : int, ax : int, ay : int, bx : int, by : int, cx : int, cy : int, depth : int) : void = let
  val decomp = decompose_triangle (ax, ay, bx, by, cx, cy)
in
  if decomp.cy = decomp.ay then
    ()
  else
    let
      val ac_y_pct = (65536 * (decomp.by - decomp.ay)) / (decomp.cy - decomp.ay)
      val cx_at_by = decomp.ax + ((ac_y_pct * (decomp.cx - decomp.ax)) / 65536)

      fun rasterize_lines {k : int | 0 <= k} .<k>. (color : int, depth : int, uy : int, ly : int, lux : int, llx : int, rux : int, rlx : int, max_count : int(k)) = let
        val mid_lx = (lux + llx) / 2
        val mid_rx = (rux + rlx) / 2
        val mid_y = (uy + ly) / 2
      in
        if max_count = 0 then
          ()
        else if uy = ly then
          ()
        else
          let
            val () = insert_raster (color, depth, mid_y, mid_lx, mid_rx)
            val () =
              if uy < (mid_y - 1) then
                begin
                  rasterize_lines (color, depth, uy, mid_y, lux, mid_lx, rux, mid_rx, max_count - 1)
                end
              else
                ()
          in
            if mid_y < (ly - 1) then
              begin
                rasterize_lines (color, depth, mid_y, ly, mid_lx, llx, mid_rx, rlx, max_count - 1)
              end
            else
              ()
          end
      end
    in
      insert_raster (color, depth, decomp.by, decomp.bx, cx_at_by) ;
      rasterize_lines (color, depth, decomp.ay, decomp.by, decomp.ax, decomp.bx, decomp.ax, cx_at_by, 200) ;
      rasterize_lines (color, depth, decomp.by, decomp.cy, decomp.bx, decomp.cx, cx_at_by, decomp.cx, 200)
    end
end

fn normal_z (p1: struct_vertex, p2: struct_vertex, p3: struct_vertex): int = let
    val ax = p2.x - p1.x
    val ay = p2.y - p1.y
    val bx = p3.x - p1.x
    val by = p3.y - p1.y
in
    (ax * by) - (ay * bx)
end

fn draw_triangles
   {st : int | 0 <= st}
  (  start_tri: int(st),
     last_vtx: int,
     dist: int,
     angle: int,
     vtx: !arrszref(struct_vertex),
     tri: !arrszref(struct_triangle)
  ): void = let
  val (dsin, dcos) = get_sin_cos (angle)

  fun do_one_triangle
    {idx : int | 0 <= idx}
    .<idx>.
    ( vtx: !arrszref(struct_vertex),
      tri: !arrszref(struct_triangle),
      n : int(idx)
    ): void = let

    val the_tri = get_triangle (tri, n)
    val the_tri_a : int = g1ofg0_int (the_tri.a)
    val the_tri_b : int = g1ofg0_int (the_tri.b)
    val the_tri_c : int = g1ofg0_int (the_tri.c)
    val vtx_a : struct_vertex = transform_vtx (dcos, dsin, dist, 30000, get_any_vertex (last_vtx, vtx, the_tri_a))
    val vtx_b : struct_vertex = transform_vtx (dcos, dsin, dist, 30000, get_any_vertex (last_vtx, vtx, the_tri_b))
    val vtx_c : struct_vertex = transform_vtx (dcos, dsin, dist, 30000, get_any_vertex (last_vtx, vtx, the_tri_c))
    val depth = (vtx_a.z + vtx_b.z + vtx_c.z) / 3
    val _ =
        if normal_z (vtx_a, vtx_b, vtx_c) < 0 then
            make_triangle (the_tri.color, vtx_a.x, vtx_a.y, vtx_b.x, vtx_b.y, vtx_c.x, vtx_c.y, depth)
        else
            ()
  in
    if n <= 0 then
      ()
    else
      do_one_triangle (vtx, tri, (n - 1))
  end
in
  do_one_triangle (vtx, tri, start_tri)
end

fn show_rasterize_info () = let
 fun show_r_info {k : int | 0 <= k} .<k>. (y : int, count : int(k)) =
   if count = 0 then
     ()
   else
     let
       val this_lst = get_line_ptr (y, NIL)
     in
       println! (y, " line") ;
       write_list this_lst ;
       consume_list this_lst ;
       show_r_info (y + 1, count - 1)
     end
in
  show_r_info (0, 199)
end
